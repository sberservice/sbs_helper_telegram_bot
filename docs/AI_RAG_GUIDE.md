# AI RAG Guide

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø –≤–Ω–µ–¥—Ä–µ–Ω–∏—è RAG-–ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –≤ –º–æ–¥—É–ª—å `ai_router`.

RAG-–ø–æ—Ç–æ–∫ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã,
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ AI,
- –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∏ —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ LLM.

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ MVP

- –ù–æ–≤—ã–π intent: `rag_qa`.
- –ù–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: `RagQaHandler` –≤ `src/sbs_helper_telegram_bot/ai_router/intent_handlers.py`.
- –°–µ—Ä–≤–∏—Å –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π: `RagKnowledgeService` –≤ `src/sbs_helper_telegram_bot/ai_router/rag_service.py`.
- –ê–¥–º–∏–Ω-–∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ Telegram: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ —Å –ø–æ–¥–ø–∏—Å—å—é `#rag`.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: `PDF`, `DOCX`, `TXT`, `MD`, `HTML`.
- –î–ª—è `HTML` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `HTMLHeaderTextSplitter` (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏), —á—Ç–æ–±—ã —É—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ `h1-h6`.
- –î–ª—è `HTML` –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback –Ω–∞ –æ—á–∏—â–µ–Ω–Ω—ã–π plain-text chunking, –µ—Å–ª–∏ header-splitter –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ –≤–µ—Ä–Ω—É–ª —á–∞–Ω–∫–æ–≤.
- –î–ª—è `HTML` –¥–æ—Å—Ç—É–ø–µ–Ω runtime-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å `ai_rag_html_splitter_enabled` –≤ –∞–¥–º–∏–Ω-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö AI (–º–æ–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å header-splitter).
- –ù–∞ Python `3.14+` –∏–º–ø–æ—Ä—Ç LangChain splitters –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ `pydantic.v1`), –ø–æ—ç—Ç–æ–º—É –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback chunking.
- –¢–∞–±–ª–∏—Ü—ã –ë–î: `rag_documents`, `rag_chunks`, `rag_corpus_version`, `rag_query_log`.
- TTL-–∫—ç—à –æ—Ç–≤–µ—Ç–æ–≤ RAG –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.
- UX-—Å—Ç–∞—Ç—É—Å –¥–ª—è RAG: –ø–æ—Å–ª–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–∫ `rag_qa` –±–æ—Ç –º–µ–Ω—è–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —Å ¬´–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å¬ª –Ω–∞ ¬´–û–∂–∏–¥–∞—é –æ—Ç–≤–µ—Ç–∞ –ò–ò¬ª –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.

## –ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç

1. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —á–∞—Ç –±–æ—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç.
2. –í –ø–æ–¥–ø–∏—Å–∏ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É —É–∫–∞–∑—ã–≤–∞–µ—Ç `#rag` –≤ –Ω–∞—á–∞–ª–µ –ø–æ–¥–ø–∏—Å–∏.
3. –ë–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É—Å–ø–µ—à–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É, ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —á–∏—Å–ª–æ —á–∞–Ω–∫–æ–≤.

## CRUD-–∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

- `#rag help` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º.
- `#rag list [active|archived|deleted|all] [limit]` ‚Äî —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
- `#rag info <id>` ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
- `#rag archive <id>` ‚Äî –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç –≤ `archived`.
- `#rag restore <id>` ‚Äî –≤–µ—Ä–Ω—É—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ `active`.
- `#rag delete <id>` ‚Äî –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (`status=deleted`).
- `#rag purge <id>` ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î.

## –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π DeepSeek (–∞–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)

- –ü—É—Ç—å: `üõ†Ô∏è –ê–¥–º–∏–Ω –±–æ—Ç–∞` ‚Üí `‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞` ‚Üí `üß† AI –º–æ–¥–µ–ª—å`.
- –†–µ–∂–∏–º—ã:
	- `deepseek-chat` ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º.
	- `deepseek-reasoner` ‚Äî —É—Å–∏–ª–µ–Ω–Ω—ã–π reasoning-—Ä–µ–∂–∏–º.
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º:
	- –º–æ–¥–µ–ª—å –¥–ª—è *–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ intent*;
	- –º–æ–¥–µ–ª—å –¥–ª—è *–æ—Ç–≤–µ—Ç–æ–≤ chat/RAG*.
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç—É–º–±–ª–µ—Ä `HTML splitter` –¥–ª—è RAG HTML-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ runtime (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞).

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ AI

- –í runtime-–ª–æ–≥–∞—Ö `ai_router` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è:
	- –ø—Ä–æ–≤–∞–π–¥–µ—Ä (`provider`),
	- –º–æ–¥–µ–ª—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (`model` –≤ `AI classification`),
	- –º–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ (`model` –≤ `AI chat request`, –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª chat/fallback).
- –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç–∏–≤–Ω–æ–π –º–æ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- `AI_RAG_ENABLED`
- `AI_RAG_MAX_FILE_SIZE_MB`
- `AI_RAG_MAX_CHUNKS_PER_DOC`
- `AI_RAG_CHUNK_SIZE`
- `AI_RAG_CHUNK_OVERLAP`
- `AI_RAG_TOP_K`
- `AI_RAG_MAX_CONTEXT_CHARS`
- `AI_RAG_CACHE_TTL_SECONDS`
- `AI_RAG_HTML_SPLITTER_ENABLED`

Runtime-–∫–ª—é—á –≤ `bot_settings`:
- `ai_rag_html_splitter_enabled` (`1` ‚Äî –≤–∫–ª—é—á—ë–Ω, `0` ‚Äî –≤—ã–∫–ª—é—á–µ–Ω)

## SQL-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```bash
mysql -u root -p sprint_db < scripts/ai_rag_setup.sql
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞

- Retrieval –∏—Å–ø–æ–ª—å–∑—É–µ—Ç lexical scoring –ø–æ —á–∞–Ω–∫–∞–º (–±–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î).
- –ö—ç—à —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –Ω–µ —à–∞—Ä–∏—Ç—Å—è –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏.
- –ù–µ—Ç UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ (–∞—Ä—Ö–∏–≤–∞—Ü–∏—è/—É–¥–∞–ª–µ–Ω–∏–µ) ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∞.
- Metadata –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ HTML —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞ —á–∞–Ω–∫–∞, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ –ë–î —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ `chunk_text`.

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥

- –î–æ–±–∞–≤–∏—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å (FAISS/Qdrant) –∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏.
- –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ (`—Å–ø–∏—Å–æ–∫`, `–∞—Ä—Ö–∏–≤`, `—É–¥–∞–ª–µ–Ω–∏–µ`).
- –î–æ–±–∞–≤–∏—Ç—å —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å —Ç–æ—á–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç/—á–∞–Ω–∫.
