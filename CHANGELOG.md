# Changelog

Все заметные изменения проекта фиксируются в этом файле.

Формат основан на Keep a Changelog,
а версияция следует Semantic Versioning.

## [0.1.3] - 2026-02-21

### Added
- Пул соединений MySQL (`MySQLConnectionPool`) в `database.py` — вместо создания нового TCP-соединения на каждый запрос (~100-200мс) используется пул из 5 готовых соединений (~1-2мс). Размер настраивается через `DB_POOL_SIZE`.
- TTL-кеш настроек (`_SETTINGS_CACHE_TTL=60с`) в `bot_settings.py` — повторные вызовы `get_setting()` берут значение из памяти, а не из БД. Кеш сбрасывается автоматически при `set_setting()`.
- Консолидированная проверка авторизации `get_user_auth_status()` в `telegram_user.py` — все проверки (chat_members, manual_users, invites, is_admin) выполняются за одно подключение к БД вместо 6-9 отдельных.
- Кеш статуса здоровья налоговой (`_HEALTH_CACHE_TTL=60с`) в `health_check.py` — `get_tax_health_status_lines()` кеширует результат, сбрасывается при `record_health_status()`.
- Тесты `tests/test_performance_optimizations.py` — 20 тестов для пула соединений, кеша настроек, пакетной загрузки модулей, консолидированной авторизации и кеша здоровья.

### Changed
- `get_all_module_states()` и `get_modules_config()` загружают настройки всех модулей одним SQL-запросом `WHERE IN (...)` вместо 8 отдельных запросов.
- `get_user_categories_this_month()` в `certification_logic.py` — устранён N+1 паттерн: ранги по категориям вычисляются в одном соединении к БД, а не N отдельных.
- Обработчик `text_entered` в `telegram_bot.py` использует `get_user_auth_status()` вместо разрозненных проверок.

### Fixed
- Время отклика обработчиков `reply_main_menu` (~3.8с→<0.5с), `reply_modules_menu` (~5с→<0.2с), `reply_ticket_validator_submenu` (~7.5с→<0.5с), `certification_my_ranking` (~2.4с→<0.5с) за счёт устранения избыточных TCP-соединений к MySQL.

## [0.1.2] - 2026-02-21

### Added
- Логирование профиля обработки входящего текста в `text_entered`: `total_ms` от получения сообщения до завершения действия и поэтапные тайминги в миллисекундах (`steps=[...]`).
- Тесты `tests/test_telegram_bot_markdown_safe.py` для проверки форматирования шагов профилирования и наличия сводного профилирующего лога при обработке сообщения.

### Changed
- Оптимизирована ветка авторизации по инвайту: статус инвайта теперь вычисляется один раз и переиспользуется в проверках.

### Fixed
- Нет изменений.

## [0.1.1] - 2026-02-21

### Added
- Регрессионные тесты: `tests/test_telegram_bot_markdown_safe.py` для fallback-отправки MarkdownV2 и новые кейсы в `tests/test_llm_provider.py` для частично обрезанного JSON-ответа LLM.

### Changed
- В `DeepSeekProvider.classify()` увеличен `max_tokens` для классификации (`512` → `1024`), чтобы снизить риск обрезки JSON при длинных заявках.
- Промпт классификации обновлён: для `ticket_validation` модель должна передавать в `parameters.ticket_text` только информативный фрагмент, а не дублировать весь длинный текст.

### Fixed
- Исправлен сценарий `Can't parse entities` при отправке AI-ответов: добавлен безопасный fallback повторной отправки с полным экранированием MarkdownV2.
- Исправлен парсинг частично обрезанного JSON от LLM: добавлен fallback-извлекатель `intent/confidence/explain_code`, чтобы не проваливаться в `NO_JSON_IN_RESPONSE` при длинных ответах.

## [0.1.0] - 2026-02-21

### Added
- **AI-маршрутизатор**: новый модуль `ai_router` для интеллектуальной обработки произвольного текста через DeepSeek API (OpenAI-совместимый). Поддерживает маршрутизацию к 5 модулям (UPOS-ошибки, Валидация заявок, КТР, Аттестация, Новости) и свободный диалог с LLM.
- Абстракция `LLMProvider` с реализацией `DeepSeekProvider`; расширяемая фабрика через `register_provider()`.
- Circuit breaker: автоматический переход в degrade-режим при серии ошибок LLM-провайдера (CLOSED → OPEN → HALF_OPEN).
- Per-user sliding-window rate limiter для защиты от спама и контроля стоимости API.
- Менеджер контекста диалога: хранение 3–5 последних сообщений с TTL для поддержки коротких диалогов.
- Повторная проверка admin-прав в callback-ветках `handle_callback` (`admin_bot_part.py`) для защиты от stale inline-клавиатур.
- Hard-disable модулей в runtime: при выключении модуля через админку AI не маршрутизирует к нему, а кнопки меню показывают сообщение о деактивации.
- Логирование результатов AI-классификации в таблицу `ai_router_log` (intent, confidence, explain_code, response_time_ms).
- SQL-скрипт `scripts/ai_router_setup.sql` для создания таблицы логов и настройки модуля.
- `MODULE_CONFIG` для `ai_router` и `news` в `bot_settings.py`.
- Тесты: `test_circuit_breaker.py`, `test_rate_limiter.py`, `test_context_manager.py`, `test_llm_provider.py`, `test_intent_handlers.py`, `test_ai_router.py`, `test_admin_callback_auth.py`.

### Changed
- `text_entered` в `telegram_bot.py`: нераспознанный текст теперь маршрутизируется через AI-роутер перед показом стандартного сообщения об ошибке; при нажатии кнопок меню контекст AI-диалога очищается.
- Конфигурация env-переменных расширена: `DEEPSEEK_API_KEY`, `DEEPSEEK_BASE_URL`, `DEEPSEEK_MODEL`, `AI_CONFIDENCE_THRESHOLD`, `AI_RATE_LIMIT_*`, `AI_CIRCUIT_BREAKER_*`, и др.

## [0.0.13] - 2026-02-20

### Fixed
- При нажатии кнопки меню во время нестабильного соединения (`httpx.ConnectError`, `httpx.RemoteProtocolError` и другие сетевые ошибки) бот теперь отвечает пользователю всплывающим уведомлением «Нет связи с сервером» вместо молчания. Добавлен вспомогательный `_answer_callback_silent` для ответа на callback-запрос без риска зацикливания обработки.

## [0.0.12] - 2026-02-20

### Changed
- Формат отображения плановых работ `OUTAGE_TYPE_RED` изменён на `с ЧЧ:ММ ДД.ММ по ЧЧ:ММ ДД.ММ.ГГГГ МСК`.

## [0.0.11] - 2026-02-19

### Changed
- Формат отображения плановых работ `OUTAGE_TYPE_RED` изменён на `ЧЧ:ММ ДД.ММ.ГГГГ - ЧЧ:ММ ДД.ММ.ГГГГ`.

## [0.0.10] - 2026-02-19

### Added
- Добавлен регрессионный тест `tests/test_health_check.py` для проверки отображения дат начала и окончания в `OUTAGE_TYPE_RED`.

### Changed
- В отображении плановых работ типа `OUTAGE_TYPE_RED` теперь показываются обе даты окна: начало и окончание \(вместо формулировки `до ...`\).

### Fixed
- Уточнено информирование пользователей о будущих двухдневных работах налоговой: из сообщения сразу видны точные даты начала и завершения.

## [0.0.9] - 2026-02-18

### Added
- Добавлен регрессионный async-тест на обработчик `show_my_ranking`, чтобы исключить повторный `NameError` по `expiry_lines`.

### Changed
- Нет изменений.

### Fixed
- Исправлена инициализация `expiry_lines` в `show_my_ranking` \(модуль аттестации\).

## [0.0.8] - 2026-02-18

### Added
- В тесты модуля аттестации добавлены проверки порядка сложностей вопросов: `easy` → `medium` → `hard`.

### Changed
- В генерации тестов сохранена случайность внутри каждой сложности, но итоговый порядок выдачи вопросов фиксирован: сначала лёгкие, затем средние, затем сложные.

### Fixed
- Нет изменений.

## [0.0.7] - 2026-02-18

### Added
- В сообщение подменю аттестации добавлены текущий аттестационный ранг и строка прогресса в формате `Прогресс аттестации : [бар] XX% current/max`.

### Changed
- Нет изменений.

### Fixed
- Нет изменений.

## [0.0.6] - 2026-02-18

### Added
- Нет изменений.

### Changed
- Блок аттестации в главном меню упрощён: удалены отдельные строки про баллы, максимум, число тестов, срок результата по категории и последний успешный тест.
- Добавлена единая строка прогресса формата `Прогресс аттестации : [бар] XX% current/max`.

### Fixed
- Нет изменений.

## [0.0.5] - 2026-02-18

### Added
- Нет изменений.

### Changed
- Формула `certification_points` изменена: теперь очки считаются как сумма лучших процентов тестов по категориям за последние 30 дней \(100% в категории = 100 очков\).
- Максимально достижимые очки пересчитаны как `active_categories * 100`.

### Fixed
- Нет изменений.

## [0.0.4] - 2026-02-18

### Added
- Добавлены тесты фильтрации событий геймификации для временного режима только аттестации.

### Changed
- Временно отключена обработка событий геймификации для всех модулей, кроме `certification.*`.

### Fixed
- Нет изменений.

## [0.0.3] - 2026-02-18

### Added
- В главное меню добавлен прогресс аттестации к максимуму очков и визуальный прогресс-бар.

### Changed
- Нет изменений.

### Fixed
- Нет изменений.

## [0.0.2] - 2026-02-18

### Added
- На экране «Мой рейтинг» добавлен прогресс-бар аттестации с отображением очков относительно динамического максимума и следующей ступени.

### Changed
- Ступень «Мастер аттестации» перенесена на 90% от максимума очков.
- Добавлена новая ultimate-ступень «Абсолют» на 100%.

### Fixed
- Нет изменений.

## [0.0.1] - 2024-06-12 

### Added
- В интерфейс аттестации добавлен полный список рангов с порогами баллов на экране «Мой рейтинг».

### Changed
- Для пользователей с истекшими результатами категорий добавлено явное предупреждение о возможном снижении аттестационного ранга.
- Пороги аттестационных рангов переведены с фиксированных значений на проценты от динамически рассчитываемого максимума очков.

### Fixed
- Нет изменений.
