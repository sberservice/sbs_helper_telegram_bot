# Типы заявок и умная валидация

## Обзор

Валидатор заявок теперь поддерживает **различные типы заявок** (шаблоны), где каждый тип имеет свой набор правил валидации. Бот может автоматически определять, какой тип заявки отправляет пользователь, на основе ключевых слов и применять только соответствующие правила валидации.

## Как это работает

### 1. Определение типа заявки

Когда пользователь отправляет заявку, бот:
1. Загружает все активные типы заявок из базы данных
2. Оценивает каждый тип на основе совпадений ключевых слов в тексте заявки
3. Выбирает тип заявки с наивысшей оценкой
4. Загружает правила валидации, специфичные для этого типа заявки
5. Валидирует заявку, используя только релевантные правила

### 2. Определение на основе ключевых слов

Каждый тип заявки имеет список ключевых слов для определения, хранящийся в формате JSON:

```json
["установка", "монтаж", "новое оборудование", "подключение"]
```

Бот подсчитывает вхождения этих ключевых слов и выбирает тип с наибольшим количеством совпадений.

### 3. Сопоставление правил

Правила валидации сопоставляются с типами заявок через промежуточную таблицу `ticket_validator_ticket_type_rules`, создавая отношение многие-ко-многим:
- Одно правило может использоваться в нескольких типах заявок
- Один тип заявки может иметь несколько правил

## Схема базы данных

### Новые таблицы

#### `ticket_validator_ticket_types`
Хранит различные типы сервисных запросов.

| Столбец | Тип | Описание |
|--------|------|-------------|
| id | bigint | Первичный ключ |
| type_name | varchar(255) | Название типа заявки |
| description | text | Описание |
| detection_keywords | text | JSON массив ключевых слов |
| active | tinyint(1) | Флаг активности |
| created_timestamp | bigint | Время создания |

#### `ticket_validator_ticket_type_rules`
Промежуточная таблица, сопоставляющая правила с типами заявок.

| Столбец | Тип | Описание |
|--------|------|-------------|
| id | bigint | Первичный ключ |
| ticket_type_id | bigint | FK к ticket_types |
| validation_rule_id | bigint | FK к validation_rules |
| created_timestamp | bigint | Время создания |

#### `validation_history`
Включает столбец `ticket_type_id` для отслеживания определенного типа.

## Установка

### 1. Создание схемы базы данных

```bash
mysql -u user -p database < schema.sql
```

### 2. Загрузка типов заявок

```bash
mysql -u user -p database < scripts/initial_ticket_types.sql
```

Типы заявок по умолчанию:
1. **Установка оборудования** - Установка нового оборудования
2. **Техническое обслуживание** - Плановое обслуживание
3. **Ремонт** - Ремонт оборудования
4. **Регистрация в ФНС** - Регистрация в налоговой службе
5. **Замена оборудования** - Замена оборудования

### 3. Сопоставление правил с типами заявок

```bash
# Создание сопоставлений правил с типами
mysql -u user -p database < scripts/map_rules_to_ticket_types.sql
```

## Примеры использования

### Пример 1: Заявка на установку

**Пользователь отправляет:**
```
Заявка на установку оборудования

Организация: ООО "Новая компания"
ИНН: 1234567890
Система налогообложения: УСН

Контактное лицо: Петров П.П.
Телефон: +7 (999) 123-45-67

Адрес установки: г. Москва, ул. Примерная, д. 1
Дата установки: 25.01.2026

Оборудование: АТОЛ 91Ф
Код активации: ABC123XYZ456
```

**Бот определяет:** "Установка оборудования" (ключевые слова: "установка оборудования")  
**Применяемые правила валидации:**
- ✅ Система налогообложения
- ✅ ИНН
- ✅ Организация
- ✅ Контактное лицо
- ✅ Телефон
- ✅ Адрес установки
- ✅ Код активации
- ✅ Тип оборудования
- ✅ Дата

**Результат:** ✅ Заявка прошла валидацию! (тип: _Установка оборудования_)

### Пример 2: Заявка на обслуживание

**Пользователь отправляет:**
```
Техническое обслуживание

Компания: ООО "Рога и Копыта"
ИНН: 9876543210
Налогообложение: ОСНО

ФИО: Иванов И.И.
Тел: 8 495 111-22-33

Оборудование: Меркурий 185Ф
Дата ТО: 30.01.2026
```

**Бот определяет:** "Техническое обслуживание" (ключевые слова: "техническое обслуживание", "ТО")  
**Применяемые правила валидации:**
- ✅ Общие правила (налог, ИНН, организация, контакт, телефон)
- ✅ Тип оборудования
- ✅ Дата обслуживания
- ❌ БЕЗ кода активации (не требуется для обслуживания)
- ❌ БЕЗ адреса установки

**Результат:** ✅ Заявка прошла валидацию! (тип: _Техническое обслуживание_)

### Пример 3: Заявка на ремонт

**Пользователь отправляет:**
```
Ремонт кассы

Организация: ИП Сидоров
ИНН: 123456789012
УСН

Контакт: Сидоров С.С.
Телефон: +79991234567

Оборудование: АТОЛ 90Ф
Проблема: не печатает чеки
```

**Бот определяет:** "Ремонт" (ключевые слова: "ремонт", "проблема")  
**Применяемые правила валидации:**
- ✅ Только общие правила
- ✅ Тип оборудования
- ❌ БЕЗ кода активации (не замена)
- ❌ БЕЗ даты обслуживания (срочный ремонт)
- ❌ БЕЗ адреса (ремонт существующего)

**Результат:** ✅ Заявка прошла валидацию! (тип: _Ремонт_)

## Изменения в API

### validators.py

#### Новый: класс данных `TicketType`
```python
@dataclass
class TicketType:
    id: int
    type_name: str
    description: str
    detection_keywords: List[str]
    active: bool = True
```

#### Новая: функция `detect_ticket_type()`
```python
def detect_ticket_type(ticket_text: str, ticket_types: List[TicketType]) -> Optional[TicketType]:
    """Определить тип заявки из текста на основе ключевых слов."""
```

#### Обновлен: `ValidationResult`
```python
@dataclass
class ValidationResult:
    # ... существующие поля ...
    detected_ticket_type: Optional[TicketType] = None  # НОВОЕ
```

#### Обновлена: `validate_ticket()`
```python
def validate_ticket(ticket_text: str, rules: List[ValidationRule], 
                   detected_ticket_type: Optional[TicketType] = None) -> ValidationResult:
```

### validation_rules.py

#### Новые функции
```python
def load_all_ticket_types() -> List[TicketType]:
    """Загрузить все активные типы заявок из базы данных."""

def load_ticket_type_by_id(ticket_type_id: int) -> Optional[TicketType]:
    """Загрузить конкретный тип заявки по ID."""
```

#### Обновлена: `load_rules_from_db()`
```python
def load_rules_from_db(ticket_type_id: Optional[int] = None) -> List[ValidationRule]:
    """Загрузить правила для конкретного типа заявки или все правила, если type_id равен None."""
```

#### Обновлена: `store_validation_result()`
```python
def store_validation_result(userid, ticket_text, is_valid, failed_rules, 
                           ticket_type_id: Optional[int] = None) -> int:
```

## Управление типами заявок

### Добавление нового типа заявки

```sql
INSERT INTO ticket_types 
(type_name, description, detection_keywords, active, created_timestamp)
VALUES 
('Модернизация', 
 'Обновление программного обеспечения',
 '["модернизация", "обновление", "апгрейд", "ПО", "прошивка"]',
 1,
 UNIX_TIMESTAMP());
```

### Сопоставление правил с новым типом

```sql
-- Сопоставить общие правила (1,3,5,6,7,10) + специфичные правила (8,9)
INSERT INTO ticket_type_rules (ticket_type_id, validation_rule_id, created_timestamp)
SELECT 6, id, UNIX_TIMESTAMP()  -- 6 = ID нового типа заявки
FROM validation_rules 
WHERE id IN (1,3,5,6,7,8,9,10);
```

### Обновление ключевых слов для определения

```sql
UPDATE ticket_types 
SET detection_keywords = '["новые", "ключевые", "слова"]'
WHERE id = 1;
```

### Деактивация типа заявки

```sql
UPDATE ticket_types SET active = 0 WHERE id = 3;
```

## Переиспользуемость правил

Правила могут использоваться в нескольких типах заявок:

| Правило | Установка | Обслуживание | Ремонт | Регистрация | Замена |
|------|--------------|-------------|--------|--------------|-------------|
| Система налогообложения | ✅ | ✅ | ✅ | ✅ | ✅ |
| ИНН | ✅ | ✅ | ✅ | ✅ | ✅ |
| Организация | ✅ | ✅ | ✅ | ✅ | ✅ |
| Контактное лицо | ✅ | ✅ | ✅ | ✅ | ✅ |
| Телефон | ✅ | ✅ | ✅ | ✅ | ✅ |
| Код активации | ✅ | ❌ | ❌ | ✅ | ✅ |
| Адрес | ✅ | ❌ | ❌ | ✅ | ✅ |
| Оборудование | ✅ | ✅ | ✅ | ✅ | ✅ |
| Дата обслуживания | ✅ | ✅ | ❌ | ❌ | ✅ |

## Преимущества

### Для пользователей
- ✅ **Только релевантная валидация** - Нет нерелевантных ошибок
- ✅ **Автоматическое определение** - Не требуется ручной выбор
- ✅ **Улучшенные сообщения об ошибках** - Контекстно-зависимая обратная связь

### Для администраторов
- ✅ **Гибкая конфигурация** - Легко добавлять новые типы заявок
- ✅ **Переиспользуемость правил** - Совместное использование правил между типами
- ✅ **Улучшенная аналитика** - Отслеживание валидации по типам заявок

### Для системы
- ✅ **Масштабируемость** - Легко добавлять новые рабочие процессы
- ✅ **Поддерживаемость** - Централизованное управление правилами
- ✅ **Производительность** - Меньше правил для валидации каждой заявки

## Резервное поведение

Если тип заявки не определен (нет совпадений ключевых слов):
- Бот валидирует, используя **ВСЕ активные правила**
- Тип заявки не показывается в ответе
- История записывает `ticket_type_id` как NULL

Это гарантирует, что валидация все еще работает даже для необычных заявок.

## Тестирование

### Тестирование определения типа заявки

```python
from src.sbs_helper_telegram_bot.ticket_validator.validators import detect_ticket_type, TicketType

ticket_types = [
    TicketType(1, "Установка", "", ["установка", "монтаж"]),
    TicketType(2, "Ремонт", "", ["ремонт", "поломка"])
]

text1 = "Заявка на установку нового оборудования"
detected = detect_ticket_type(text1, ticket_types)
assert detected.id == 1  # Установка

text2 = "Ремонт сломанной кассы"
detected = detect_ticket_type(text2, ticket_types)
assert detected.id == 2  # Ремонт
```

### Тестирование загрузки правил по типу

```python
from src.sbs_helper_telegram_bot.ticket_validator.validation_rules import load_rules_from_db

# Загрузить правила для типа заявки 1 (Установка)
installation_rules = load_rules_from_db(ticket_type_id=1)
assert len(installation_rules) == 9  # Должно быть 9 правил

# Загрузить правила для типа заявки 2 (Обслуживание)
maintenance_rules = load_rules_from_db(ticket_type_id=2)
assert len(maintenance_rules) == 7  # Должно быть 7 правил (без активации/адреса)

# Загрузить все правила
all_rules = load_rules_from_db()
assert len(all_rules) == 10  # Все 10 правил
```

## Будущие улучшения

### 1. Выбираемые пользователем типы
Добавить встроенную клавиатуру для ручного выбора типа заявки пользователями:
```python
keyboard = [[InlineKeyboardButton(t.type_name, callback_data=f"type_{t.id}") 
             for t in ticket_types]]
```

### 2. Порог уверенности
Автоматически определять только при превышении порога уверенности:
```python
if score >= MIN_CONFIDENCE_SCORE:
    detected_type = best_match
else:
    # Попросить пользователя подтвердить или выбрать
```

### 3. Определение с машинным обучением
Заменить сопоставление ключевых слов классификацией ML:
```python
from sklearn.naive_bayes import MultinomialNB
# Обучить на исторических заявках
```

### 4. Заявки с несколькими типами
Поддержка заявок, охватывающих несколько типов:
```python
detected_types: List[TicketType]  # Несколько типов
# Объединить правила из всех определенных типов
```

## Миграция со старой системы

Если у вас есть существующие заявки, валидированные со старой системой (без типов заявок):

```sql
-- Все старые записи validation_history имеют NULL ticket_type_id
-- Это нормально - они остаются доступными для запросов

-- Для ретроспективного определения типов (опционально):
UPDATE validation_history vh
SET ticket_type_id = (
    SELECT id FROM ticket_types
    WHERE LOWER(vh.ticket_text) LIKE CONCAT('%', JSON_UNQUOTE(JSON_EXTRACT(detection_keywords, '$[0]')), '%')
    LIMIT 1
)
WHERE ticket_type_id IS NULL;
```

## Устранение неполадок

### Бот определяет неправильный тип заявки
**Решение:** Уточните ключевые слова определения или добавьте более специфичные ключевые слова

```sql
UPDATE ticket_types 
SET detection_keywords = '["точное", "специфичное", "ключевое слово"]'
WHERE id = 1;
```

### Слишком много/мало примененных правил
**Решение:** Проверьте сопоставления правил

```sql
-- Посмотреть, какие правила сопоставлены с типом
SELECT vr.rule_name 
FROM validation_rules vr
JOIN ticket_type_rules ttr ON vr.id = ttr.validation_rule_id
WHERE ttr.ticket_type_id = 1;
```

### Тип заявки не определен
**Решение:** Добавьте больше ключевых слов определения или снизьте специфичность

```sql
-- Добавить общие резервные ключевые слова
UPDATE ticket_types 
SET detection_keywords = JSON_ARRAY_APPEND(detection_keywords, '$', 'заявка')
WHERE id = 1;
```

---

**Версия:** 2.0.0  
**Последнее обновление:** 21 января 2026 г.  
**Функция:** Определение типа заявки и умная валидация
