# Ticket Validator Module

Модуль проверки заявок для телеграм-бота инженеров.

## Описание

Модуль позволяет инженерам проверять правильность заполнения заявок перед их отправкой. Бот проверяет наличие обязательных полей и правильность их форматов по настраиваемым правилам валидации.

## Возможности

- ✅ Проверка обязательных полей (система налогообложения, код активации, ИНН и т.д.)
- ✅ Валидация форматов (телефон, дата, ИНН)
- ✅ Настраиваемые правила через базу данных
- ✅ История проверок для каждого пользователя
- ✅ Шаблоны корректно заполненных заявок
- ✅ Детальный отчет об ошибках

## Команды бота

- `/validate` - Начать проверку заявки
- `/help_validate` - Справка по использованию
- `/cancel` - Отменить текущую проверку

## Установка

### 1. Обновить схему базы данных

```bash
mysql -u your_user -p your_database < schema.sql
```

Это создаст три новые таблицы:
- `validation_rules` - Правила валидации
- `validation_history` - История проверок
- `ticket_templates` - Шаблоны заявок

### 2. Загрузить начальные правила валидации

```bash
mysql -u your_user -p your_database < scripts/initial_validation_rules.sql
```

Это добавит базовый набор из 10 правил проверки:
- Система налогообложения
- Код активации
- ИНН
- Адрес установки
- Контактный телефон
- Название организации
- Контактное лицо
- Тип оборудования
- Дата обслуживания
- Минимальная длина заявки

### 3. (Опционально) Загрузить примеры шаблонов

```bash
mysql -u your_user -p your_database < scripts/sample_templates.sql
```

## Использование

### Для пользователей бота

1. Отправьте команду `/validate`
2. Скопируйте текст заявки и отправьте его боту
3. Получите результат проверки с указанием найденных ошибок (если есть)
4. Исправьте ошибки и проверьте заявку повторно

### Пример валидной заявки

```
Заявка на установку оборудования

Наименование организации: ООО "Пример"
ИНН: 1234567890
Система налогообложения: УСН

Контактное лицо: Иванов Иван Иванович
Контактный телефон: +7 (999) 123-45-67

Адрес установки: г. Москва, ул. Примерная, д. 1, оф. 100
Дата обслуживания: 20.01.2026

Тип оборудования: Касса АТОЛ 91Ф
Код активации: ABC123DEF456
```

## Структура модуля

```
src/sbs_helper_telegram_bot/ticket_validator/
├── __init__.py                      # Инициализация модуля
├── validators.py                    # Классы и функции валидации
├── validation_rules.py              # Загрузка правил из БД
└── ticket_validator_bot_part.py     # Обработчики команд бота
```

## Типы правил валидации

### 1. regex
Проверка по регулярному выражению
```python
pattern: '(?i)(ИНН|инн)\\s*[:\\-]?\\s*\\d{10,12}'
```

### 2. required_field
Проверка наличия обязательного поля
```python
pattern: 'Система налогообложения'
```

### 3. format
Проверка специальных форматов (phone, email, date, inn)
```python
pattern: 'phone'  # или 'email', 'date', 'inn'
```

### 4. length
Проверка длины текста
```python
pattern: 'min:50,max:5000'
```

### 5. custom
Пользовательская проверка (для расширения в будущем)

## Управление правилами

### Добавить новое правило

```sql
INSERT INTO validation_rules 
(rule_name, pattern, rule_type, error_message, active, priority, created_timestamp)
VALUES 
('email_check', 
 '(?i)(email|e-mail|почта)\\s*[:\\-]?\\s*[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}', 
 'regex', 
 'Не указан email или указан в неверном формате',
 1,
 5,
 UNIX_TIMESTAMP());
```

### Отключить правило

```sql
UPDATE validation_rules SET active = 0 WHERE rule_name = 'email_check';
```

### Изменить приоритет

```sql
UPDATE validation_rules SET priority = 15 WHERE rule_name = 'tax_system';
```

Правила с более высоким приоритетом проверяются первыми.

## API функций

### validators.py

- `validate_ticket(ticket_text, rules)` - Основная функция валидации
- `validate_regex(text, pattern)` - Проверка regex
- `validate_required_field(text, field_name)` - Проверка обязательного поля
- `validate_format(text, format_type)` - Проверка формата
- `validate_length(text, length_spec)` - Проверка длины

### validation_rules.py

- `load_rules_from_db()` - Загрузить все активные правила
- `load_rule_by_id(rule_id)` - Загрузить правило по ID
- `store_validation_result(...)` - Сохранить результат проверки
- `get_validation_history(userid, limit)` - История проверок пользователя
- `load_template_by_name(name)` - Загрузить шаблон
- `list_all_templates()` - Список всех шаблонов

## Расширение функционала

### Добавление нового типа валидации

1. Добавьте новый тип в enum `RuleType` в [validators.py](src/sbs_helper_telegram_bot/ticket_validator/validators.py)
2. Реализуйте функцию валидации
3. Добавьте обработку в `validate_ticket()`

### Добавление админских команд

Для управления правилами через бота можно добавить команды:
- `/add_rule` - Добавить правило
- `/edit_rule` - Редактировать правило
- `/list_rules` - Список всех правил
- `/toggle_rule` - Включить/выключить правило

## Тестирование

Проверьте работу модуля:

```bash
# Запустить бота
python -m src.sbs_helper_telegram_bot.telegram_bot.telegram_bot

# В Telegram:
# 1. /validate
# 2. Отправьте тестовую заявку
# 3. Проверьте результат
```

## Логи и отладка

Модуль использует стандартный Python logging. Для включения DEBUG режима:

```python
# config/settings.py
DEBUG = 1
```

Логи валидации появятся в консоли с префиксом модуля.

## База данных

### Таблица validation_rules

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | ID правила |
| rule_name | varchar(255) | Название правила |
| pattern | text | Паттерн для проверки |
| rule_type | enum | Тип правила |
| error_message | text | Сообщение об ошибке |
| active | tinyint(1) | Активно ли правило |
| priority | int | Приоритет (выше = раньше) |
| created_timestamp | bigint | Время создания |
| updated_timestamp | bigint | Время обновления |

### Таблица validation_history

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | ID записи |
| userid | bigint | Telegram user ID |
| ticket_text | text | Текст заявки |
| validation_result | enum | valid/invalid |
| failed_rules | text | JSON массив проваленных правил |
| timestamp | bigint | Время проверки |

### Таблица ticket_templates

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | ID шаблона |
| template_name | varchar(255) | Название шаблона |
| template_text | text | Текст шаблона |
| description | text | Описание |
| active | tinyint(1) | Активен ли |
| created_timestamp | bigint | Время создания |

## Производительность

- Все правила загружаются один раз при каждой проверке
- Используются индексы на active, priority, userid
- Средняя скорость валидации: < 100ms для 10 правил
- История хранится неограниченно (можно добавить очистку старых записей)

## Безопасность

- ✅ Все SQL-запросы используют параметризацию
- ✅ Regex паттерны обрабатываются через try/except
- ✅ Пользовательский ввод не выполняется как код
- ✅ История привязана к userid (пользователи видят только свои записи)

## Известные ограничения

- Максимальная длина текста заявки ограничена типом TEXT (~65KB)
- ConversationHandler не сохраняет состояние при перезапуске бота
- Один пользователь может проверять только одну заявку за раз
- Шаблоны не поддерживают переменные/плейсхолдеры

## Roadmap

- [ ] Админская панель для управления правилами через бота
- [ ] Статистика по валидациям (топ ошибок, процент успешных)
- [ ] Экспорт истории в CSV/Excel
- [ ] Поддержка вложенных правил (если X, то проверять Y)
- [ ] Автоматическое исправление простых ошибок
- [ ] Интеграция с внешними API для проверки ИНН/ОГРН

## Поддержка

При возникновении проблем:
1. Проверьте логи бота
2. Убедитесь, что таблицы созданы и правила загружены
3. Проверьте правильность regex паттернов
4. Создайте issue в репозитории проекта
