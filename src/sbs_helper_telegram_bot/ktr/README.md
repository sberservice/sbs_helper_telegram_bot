# KTR Module (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç)

–ú–æ–¥—É–ª—å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–¥–æ–≤ –ö–¢–† (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç) –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç–∞—Ö –≤ –º–∏–Ω—É—Ç–∞—Ö.

## –û–ø–∏—Å–∞–Ω–∏–µ

–ö–¢–† - —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∫–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ. –ö–∞–∂–¥—ã–π –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç:
- **–ö–æ–¥** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –±—É–∫–≤–µ–Ω–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, POS2421)
- **–û–ø–∏—Å–∞–Ω–∏–µ** - –Ω–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
- **–ú–∏–Ω—É—Ç—ã** - –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö
- **–ö–∞—Ç–µ–≥–æ—Ä–∏—è** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–æ–¥–æ–≤ –ø–æ —Ç–∏–ø—É —Ä–∞–±–æ—Ç

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üîç –ü–æ–∏—Å–∫ –∫–æ–¥–∞ –ö–¢–† –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
- üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–æ–¥–æ–≤

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- üìã –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∫–æ–¥–æ–≤
- ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–¥–æ–≤
- üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç
- üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–¥–æ–≤
- üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
- ‚ùì –ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–¥–æ–≤ (–∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤ –±–∞–∑–µ)
- üìà –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- üì• –ò–º–ø–æ—Ä—Ç –∫–æ–¥–æ–≤ –∏–∑ CSV —Ñ–∞–π–ª–∞

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-—Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü:
```sql
mysql -u user -p database < scripts/ktr_setup.sql
```

2. –î–æ–±–∞–≤—å—Ç–µ –º–æ–¥—É–ª—å –≤ –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –±–æ—Ç–∞ (telegram_bot.py)

## –ò–º–ø–æ—Ä—Ç –∏–∑ CSV

### –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞

CSV —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã:

| –°—Ç–æ–ª–±–µ—Ü | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π |
|---------|------------------------|----------|--------------|
| code | –∫–æ–¥, ktr_code, –∫–æ–¥_–∫—Ç—Ä | –ö–æ–¥ –ö–¢–† | –î–∞ |
| description | –æ–ø–∏—Å–∞–Ω–∏–µ, desc, –Ω–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã | –î–∞ |
| minutes | –º–∏–Ω—É—Ç—ã, –≤—Ä–µ–º—è, time, –º–∏–Ω | –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –≤ –º–∏–Ω—É—Ç–∞—Ö | –î–∞ |
| category | –∫–∞—Ç–µ–≥–æ—Ä–∏—è, cat | –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ | –ù–µ—Ç |

### –ü—Ä–∏–º–µ—Ä CSV

```csv
code,description,minutes,category
POS2421,–£—Å—Ç–∞–Ω–æ–≤–∫–∞ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–∞,90,POS-—Ç–µ—Ä–º–∏–Ω–∞–ª—ã
POS2422,–ó–∞–º–µ–Ω–∞ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–∞,60,POS-—Ç–µ—Ä–º–∏–Ω–∞–ª—ã
KASS001,–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Å—Å—ã,120,–ö–∞—Å—Å—ã
NET001,–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞,30,–°–µ—Ç–µ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- **–ö–æ–¥–∏—Ä–æ–≤–∫–∞:** UTF-8 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –∏–ª–∏ Windows-1251
- **–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å:** –∑–∞–ø—è—Ç–∞—è (,) –∏–ª–∏ —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π (;)
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä:** 5 –ú–ë

#### –î–ª—è Mac (Numbers):
1. –§–∞–π–ª ‚Üí –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ ‚Üí CSV
2. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–¥–∏—Ä–æ–≤–∫—É Unicode (UTF-8)

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã

- `ktr_categories` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–æ–¥–æ–≤ –ö–¢–†
- `ktr_codes` - –∫–æ–¥—ã –ö–¢–† —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç–∞–º–∏
- `ktr_unknown_codes` - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–¥—ã, –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- `ktr_request_log` - –ª–æ–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã ktr_codes

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | bigint | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| code | varchar(50) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ö–¢–† |
| category_id | bigint | –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL) |
| description | text | –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã |
| minutes | int | –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –≤ –º–∏–Ω—É—Ç–∞—Ö |
| active | tinyint | –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (1/0) |
| created_timestamp | bigint | Unix timestamp —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_timestamp | bigint | Unix timestamp –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

## API

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

```python
from src.sbs_helper_telegram_bot.ktr.ktr_bot_part import (
    get_ktr_code_by_code,
    create_ktr_code,
    update_ktr_code,
    delete_ktr_code,
    get_all_ktr_codes,
    get_all_categories,
    import_ktr_codes_from_csv
)

# –ü–æ–∏—Å–∫ –∫–æ–¥–∞
code_info = get_ktr_code_by_code("POS2421")

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–∞
code_id = create_ktr_code("NEW001", "–ù–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞", 45, category_id=1)

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
update_ktr_code(code_id, 'minutes', 60, update_timestamp=True)
```

## –í–µ—Ä—Å–∏—è

- **–í–µ—Ä—Å–∏—è:** 1.0.0
- **–ê–≤—Ç–æ—Ä:** SberService
